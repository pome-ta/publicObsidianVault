ã„ã‚„ã€ã¾ã Phase 10 ã§ã™ã‚‰å®Ÿæ–½ã—ã¦ã„ãªã„ã€‚
Phase9 ã‚’çµ‚ãˆã¦ã„ã‚‹çŠ¶æ…‹ã€‚

ã‚ãªãŸãŒå‡ºã—ã¦ãã‚ŒãŸå†…å®¹ã ã¨:
```
æ¬¡ã®è‡ªç„¶ãªé¸æŠžè‚¢

ã“ã“ã¾ã§æ¥ãŸçŠ¶æ…‹ã§ã€ãƒ­ãƒ¼ãƒ‰ãƒžãƒƒãƒ—ä¸Šã®åˆ†å²ã¯æ˜Žç¢ºã§ã™ã€‚

A. Phase 10ï¼ˆTS Language Service æœ¬æŽ¥ç¶šï¼‰
	â€¢	completion ã‚’ TS LS çµæžœã§åŸ‹ã‚ã‚‹
	â€¢	hover ã‚’åž‹ / symbol æƒ…å ±ã«ã™ã‚‹
	â€¢	diagnostics ç²¾åº¦å‘ä¸Š

B. CodeMirror å®ŸæŽ¥ç¶šãƒ•ã‚§ãƒ¼ã‚º
	â€¢	@codemirror/lsp-client ã¨ã®å®Ÿé…ç·š
	â€¢	editor â†’ worker â†’ response ã® end-to-end æ¤œè¨¼
	â€¢	Safariï¼ˆiOSï¼‰ç’°å¢ƒã®å®ŸæŒ™å‹•ç¢ºèª

C. è¨­è¨ˆå›ºå®šï¼ˆå®‰å®šç‰ˆã‚¿ã‚°ï¼‰
	â€¢	v0.0.3.x ã‚’ è¨­è¨ˆåŸºæº–ç‰ˆ ã¨ã—ã¦å›ºå®š
	â€¢	ä»¥é™ã¯ç ´å£Šçš„å¤‰æ›´ã‚’ç¦æ­¢

```

> A. Phase 10ï¼ˆTS Language Service æœ¬æŽ¥ç¶šï¼‰
ã“ã‚Œã€‚

## Phase 9 æ™‚ç‚¹ã§ã®çŠ¶æ…‹

ç¾çŠ¶ã®çŠ¶æ…‹ã¯ä»¥ä¸‹

```worker.js
// worker.js
// v0.0.3.10 Phase 9 clean implementation (completion / hover concrete minimal)

import { VfsCore } from './core/vfs-core.js';
import { LspCore } from './core/lsp-core.js';
import { postLog, setDebug } from './util/logger.js';

setDebug(true);

/**
 * ---- Internal document state ----
 * Phase 4ã€œ7 ã§ç¢ºç«‹ã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’å®Œå…¨ç¶­æŒ
 */
const documents = new Map(); // uri -> { version, text }
let initialized = false;

/**
 * ---- Phase 8/9 debug observability ----
 */
let lastCompletion = null;
let lastHover = null;

const handlers = {
  // --- lifecycle ---
  'worker/ready': async () => ({ ok: true }),

  // --- VFS ---
  'vfs/ensureReady': async () => {
    await VfsCore.ensureReady();
    return { ok: true };
  },

  'vfs/getEnvInfo': async () => VfsCore.getEnvInfo(),

  'vfs/resetForTest': async () => {
    VfsCore.resetForTest();
    documents.clear();
    initialized = false;
    lastCompletion = null;
    lastHover = null;
    return { ok: true };
  },

  'vfs/openFile': async (params) => {
    if (
      !params ||
      typeof params.uri !== 'string' ||
      typeof params.content !== 'string'
    ) {
      throw Object.assign(new Error('Invalid params'), { code: -32602 });
    }

    if (!VfsCore.getEnvInfo().ready) {
      throw Object.assign(new Error('VFS is not ready'), { code: -32001 });
    }

    const prev = documents.get(params.uri);
    const version = prev ? prev.version + 1 : 1;

    documents.set(params.uri, {
      uri: params.uri,
      version,
      text: params.content,
    });

    return { ok: true };
  },

  // --- LSP ---
  'lsp/initialize': async (params) => {
    const result = await LspCore.initialize(params);
    initialized = true;
    return result;
  },

  /**
   * ---- Phase 9: completion (concrete minimal) ----
   */
  'textDocument/completion': async (params) => {
    lastCompletion = params ?? null;

    if (!initialized) {
      return { isIncomplete: false, items: [] };
    }

    const uri = params?.textDocument?.uri;
    const doc = uri ? documents.get(uri) : null;
    if (!doc) {
      return { isIncomplete: false, items: [] };
    }

    // Phase 9 æœ€å°å®Ÿä½“ï¼šå¸¸ã« 1 ä»¶è¿”ã™
    return {
      isIncomplete: false,
      items: [
        {
          label: 'Phase9Completion',
          kind: 6, // Variable
          detail: 'Phase 9 minimal completion',
          insertText: 'Phase9Completion',
        },
      ],
    };
  },

  /**
   * ---- Phase 9: hover (concrete minimal) ----
   */
  'textDocument/hover': async (params) => {
    lastHover = params ?? null;

    if (!initialized) {
      return null;
    }

    const uri = params?.textDocument?.uri;
    const doc = uri ? documents.get(uri) : null;
    if (!doc) {
      return null;
    }

    // Phase 9 æœ€å°å®Ÿä½“ï¼šdocument æƒ…å ±ã‚’è¿”ã™
    return {
      contents: {
        kind: 'plaintext',
        value: `uri: ${doc.uri}\nversion: ${doc.version}`,
      },
    };
  },

  // --- debug ---
  'lsp/_debug/getLastCompletion': async () => lastCompletion,
  'lsp/_debug/getLastHover': async () => lastHover,
};

self.onmessage = async (e) => {
  const msg = e.data;
  if (!msg || msg.jsonrpc !== '2.0') return;

  const { id, method, params } = msg;
  const handler = handlers[method];

  if (!handler) {
    if (id != null) {
      self.postMessage({
        jsonrpc: '2.0',
        id,
        error: { code: -32601, message: `Method not found: ${method}` },
      });
    }
    return;
  }

  try {
    const result = await handler(params);
    if (id != null) {
      self.postMessage({ jsonrpc: '2.0', id, result });
    }
  } catch (err) {
    if (id != null) {
      self.postMessage({
        jsonrpc: '2.0',
        id,
        error: {
          code: err?.code ?? -32000,
          message: err?.message ?? String(err),
        },
      });
    }
  }
};

// RPC ready
postLog('Worker loaded and ready.');
self.postMessage({ jsonrpc: '2.0', method: 'worker/ready' });

```

```phase9-completion-hover.test.js
// test/v0.0.3/phase9-completion-hover.test.js
// v0.0.3.10 (fixed)

import {
  createTestWorker,
  waitForWorkerReady,
  sendRequest,
  sendNotification,
  addResult,
} from './test-utils.js';

console.log('ðŸ§© phase9-completion-hover.test loaded');

(async () => {
  const testName = 'phase9: completion / hover returns concrete content';
  let worker;

  try {
    /* ---------- worker boot ---------- */

    worker = createTestWorker('./js/worker.js');
    await waitForWorkerReady(worker);

    /* ---------- VFS ready (å¿…é ˆ) ---------- */

    const ready = await sendRequest(worker, 'vfs/ensureReady');
    if (!ready?.ok) {
      throw new Error('vfs/ensureReady failed');
    }

    /* ---------- initialize ---------- */

    await sendRequest(worker, 'lsp/initialize', {
      processId: null,
      rootUri: null,
      capabilities: {},
    });

    sendNotification(worker, 'lsp/initialized');

    /* ---------- open document ---------- */

    const uri = 'file:///phase9.ts';
    const content = 'const answer = 42;\nanswer';

    await sendRequest(worker, 'vfs/openFile', {
      uri,
      content,
    });

    /* ---------- completion ---------- */

    const completion = await sendRequest(worker, 'textDocument/completion', {
      textDocument: { uri },
      position: { line: 1, character: 3 },
    });

    if (
      !completion ||
      !Array.isArray(completion.items) ||
      completion.items.length === 0
    ) {
      throw new Error('completion.items is empty');
    }

    if (typeof completion.items[0].label !== 'string') {
      throw new Error('completion item has no label');
    }

    /* ---------- hover ---------- */

    const hover = await sendRequest(worker, 'textDocument/hover', {
      textDocument: { uri },
      position: { line: 0, character: 6 },
    });

    if (!hover || !hover.contents || typeof hover.contents.value !== 'string') {
      throw new Error('hover.contents invalid');
    }

    addResult(testName, true);
  } catch (err) {
    addResult(testName, false, err.message);
  } finally {
    worker?.terminate();
  }
})();

```
