CodeMirror 実接続時のファイル責務分割図

これは何か

「CodeMirror を実際に画面に接続したとき、どのファイルが何を責任持つのか」を明示した設計図。
	•	UI（エディタ）
	•	LSP クライアント（JSON-RPC）
	•	Worker / LSP サーバ

を混線させないための分割ルールを示す。

⸻

全体構成（俯瞰）

┌──────────────────────────────┐
│            main.js            │
│  (アプリ起動 / wiring only)   │
└───────────────┬──────────────┘
                │
                ▼
┌──────────────────────────────┐
│      editor/codemirror.js     │
│  CodeMirror instance & UI     │
│  - EditorState                │
│  - EditorView                 │
│  - keymap / extensions        │
└───────────────┬──────────────┘
                │ LSP events
                ▼
┌──────────────────────────────┐
│        lsp/cm-lsp-bridge.js   │
│  CodeMirror ⇄ LSP adapter     │
│  - didOpen / didChange        │
│  - completion / hover         │
│  - position mapping           │
└───────────────┬──────────────┘
                │ JSON-RPC
                ▼
┌──────────────────────────────┐
│        lsp/worker-client.js   │
│  JSON-RPC client abstraction  │
│  - send / notify              │
│  - request id management      │
│  - lifecycle control          │
└───────────────┬──────────────┘
                │ postMessage
                ▼
┌──────────────────────────────┐
│            worker.js          │
│  LSP server (your impl)       │
│  - VFS                        │
│  - document state             │
│  - completion / hover logic   │
└──────────────────────────────┘


⸻

各ファイルの責務（厳密定義）

main.js

責務
	•	アプリのエントリポイント
	•	各モジュールの生成と接続のみ

やらないこと
	•	CodeMirror API を直接触らない
	•	LSP のメソッド名を知らない

⸻

editor/codemirror.js

責務
	•	CodeMirror の EditorState / EditorView 生成
	•	extensions / theme / keymap 管理

やらないこと
	•	Worker を知らない
	•	JSON-RPC を知らない

⸻

lsp/cm-lsp-bridge.js

責務
	•	CodeMirror のイベントを LSP に変換

例:
	•	doc 初期化 → textDocument/didOpen
	•	編集差分 → textDocument/didChange
	•	補完要求 → textDocument/completion
	•	hover 要求 → textDocument/hover

重要
	•	CodeMirror と LSP の 唯一の接点

⸻

lsp/worker-client.js

責務
	•	JSON-RPC クライアント
	•	request / response / notify の保証

特徴
	•	UI 非依存
	•	CodeMirror 非依存
	•	将来 vscode-jsonrpc に置き換え可能

⸻

worker.js

責務
	•	LSP サーバ実装
	•	VFS / document lifecycle
	•	completion / hover / diagnostics

制約
	•	UI を一切知らない
	•	CodeMirror を一切知らない

⸻

なぜこの分割が重要か
	1.	テストが壊れない
	•	worker.js は今の Phase 1〜9 テスト資産をそのまま保持
	2.	CodeMirror を捨てられる
	•	Monaco / textarea にも差し替え可能
	3.	LSP 実装を外に出せる
	•	将来 multi-worker / remote LSP に移行可能

⸻

v0.0.5.x（CodeMirror 実接続）で実装される範囲
	•	editor/codemirror.js
	•	lsp/cm-lsp-bridge.js
	•	main.js の wiring 追加

worker.js は ほぼ無変更

⸻

まとめ
	•	「ファイル責務分割図」とは 実装順序を縛る設計図
	•	CodeMirror は UI レイヤに完全隔離される
	•	あなたが積み上げた Phase 1〜9 の設計は一切無駄にならない

次はこの図を元に、
	•	実ファイル skeleton を出す
	•	もしくは CodeMirror → LSP イベント対応表を作る

どちらに進むか指定してほしい。

Phase 11 完了時 想定ディレクトリ構造（調整版）

方針: js/ をアプリケーションルート（エンジン＋UI 実験場）とし、
project-root は配布・参照単位に留める。


```
project-root/
├─ index.html
│
├─ js/
│  ├─ app.js                  # アプリ起点（旧 main.js / 命名検討中）
│  │
│  ├─ worker.js               # Worker entry（JSON-RPC loop）
│  ├─ worker-rpc.js           # RPC dispatch / error handling
│  │
│  ├─ core/
│  │  ├─ vfs-core.js
│  │  ├─ document-store.js
│  │  ├─ lsp-core.js
│  │  ├─ ts-service.js
│  │  └─ diagnostics-core.js
│  │
│  ├─ lsp/
│  │  ├─ completion.js
│  │  ├─ hover.js
│  │  ├─ did-open.js
│  │  ├─ did-change.js
│  │  └─ did-close.js
│  │
│  ├─ editor/
│  │  ├─ codemirror-init.js   # CodeMirror instance 生成
│  │  ├─ cm-lsp-bridge.js     # CodeMirror ↔ LSP 接続層
│  │  └─ editor-config.js
│  │
│  ├─ util/
│  │  ├─ logger.js
│  │  ├─ uri.js
│  │  └─ position.js
│  │
│  ├─ constants/
│  │  ├─ error-codes.js
│  │  └─ lsp-methods.js
│  │
│  └─ test/
│     ├─ test-utils.js
│     ├─ v0.0.3/
│     │  ├─ phase1-*.test.js
│     │  ├─ ...
│     │  └─ phase11-*.test.js
│     └─ fixtures/
│        ├─ simple.ts
│        └─ multi-file/
│
├─ design/
│  ├─ design.md
│  ├─ phase-01.md
│  ├─ ...
│  └─ phase-11.md
│
├─ README.md
└─ package.json
```

依存関係ルール（重要）
	•	js/editor/* は js/worker/* や js/core/* を 直接 import しない
	•	依存方向は以下に限定する

editor → worker-client → worker

この制約を守ることで、Phase 11 以降（multi-worker / vscode-jsonrpc 導入）でも設計が破綻しない。

Phase 11 spec: CodeMirror ↔ LSP 接続（最小要件）

目的
	•	ブラウザ上の CodeMirror 6 エディタと、既存の Web Worker 内 LSP 実装を実接続する
	•	Phase 1〜10 で構築した LSP / VFS / diagnostics / completion / hover の成果を
UI 経由で確認可能な状態にする
	•	本フェーズでは UX の完成度は追わず、「正しい経路でイベントが流れること」を最優先とする

⸻

スコープ内（やること）

1. CodeMirror インスタンス生成
	•	CodeMirror 6 を使用
	•	単一エディタ・単一ファイル（multi-file UI は次フェーズ以降）
	•	初期テキストを与えて起動できること

2. CodeMirror → LSP（Worker）へのブリッジ
以下のイベントを Worker に通知すること:
	•	初期化時
	•	lsp/initialize
	•	lsp/initialized
	•	ドキュメント lifecycle
	•	vfs/openFile（初回）
	•	textDocument/didChange（編集時）

※ didClose は Phase 6 実装を再利用（UI 側から明示的には呼ばなくてよい）

3. LSP → CodeMirror への反映
	•	completion
	•	CodeMirror の autocomplete 拡張経由で
	•	textDocument/completion を呼び、結果を候補として表示
	•	hover
	•	hover 拡張（または簡易 mouseover）で
	•	textDocument/hover を呼び、内容を表示（console / tooltip どちらでも可）
	•	diagnostics
	•	textDocument/publishDiagnostics を受信し
	•	console.log もしくは簡易的な decoration で可視化

4. 通信モデル
	•	main thread
	•	CodeMirror
	•	LSP クライアント（最小）
	•	worker
	•	既存 worker.js
	•	JSON-RPC over postMessage

※ vscode-jsonrpc はまだ使わない（次フェーズ候補）

⸻

スコープ外（やらないこと）
	•	multi-file UI
	•	タブ管理
	•	高度な diagnostics 表示（赤線など）
	•	completion の ranking / filtering
	•	hover の Markdown 対応
	•	パフォーマンス最適化

⸻

成功条件（Definition of Done）
	•	CodeMirror 上で文字を入力すると
	•	didChange → Worker に届く
	•	diagnostics / completion / hover が破綻せず応答する
	•	Worker 側の既存 Phase 8〜9 テストが 一切壊れない
	•	Phase 11 用テスト（E2E）が 1 本以上 green

⸻

設計原則（再確認）
	•	Phase は公開 API ではなく内部設計メタ情報
	•	Version（v0.0.x.y）が外部的な進捗指標
	•	最小実装 → spec 固定 → 次フェーズ

⸻

次フェーズ候補（Phase 12 以降）
	•	vscode-jsonrpc 導入
	•	ATA（@typescript/ata）統合
	•	multi-file editor UI
	•	multi-worker（TS LS 分離）