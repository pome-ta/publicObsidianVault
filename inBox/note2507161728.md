もう面倒だから、全部書き落としていくか

# 📝 2025/08/24

## codemirror のesm.sh

さて、どれを呼んでいくか、、、


# 📝 2025/08/21

## todo ?

- スクリプトを選択できるように？
- `v0.1` の音データの外部読み込み
- ems.sh でcodemirror 組んでみる
    - キャレットがで出てくるまで戻す
    - それで相互互換性が保てるか
- [GitHub - tkihira/web-console-log](https://github.com/tkihira/web-console-log) 検証

# 📝 2025/08/20

- [GitHub - processing/p5.sound](https://github.com/processing/p5.sound.js)
- [GitHub - Tonejs/Tone.js: A Web Audio framework for making interactive music in the browser.](https://github.com/Tonejs/Tone.js)

`v0.2` は、まだ先かなぁ、、、

音止めたりするのが、全く違うかも。

# 📝 2025/08/16

gas の非同期実行のやつ、まとめておきたい。しかし、実際に走るコード見ながらでないと、難しいな。。。

## 参照あさり

- [Make google.script.run looks a promise · GitHub](https://gist.github.com/torufurukawa/64339baf16efd3598e71dd763d1db0cf)
    - これでいいんだっけ？
- [Asynchronous execution for Google App Scripts (gas) · GitHub](https://gist.github.com/sdesalas/2972f8647897d5481fd8e01f03122805)
    - こっちの方が多く引っかかる？
- [【GASの起動時間の制限を回避せよ】分割実行や非同期処理を使って高速実行を実現してみた！ - ポンコツエンジニアのごじゃっぺ開発日記。](https://www.pnkts.net/2019/12/25/gas-split-execution-and-_asynchronous-processing)
- [GASの関数をPromiseでラップする (魔法のオブジェクトProxy) #JavaScript - Qiita](https://qiita.com/Shankou/items/7b73686c3aa9364c20ce)
    - `Proxy` ?
    - [Proxy - JavaScript | MDN](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Proxy)


## もってきたやつ

### menu 系

```js
const activeSpreadsheet = SpreadsheetApp.getActiveSpreadsheet();

function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('📂 ScriptMenus')
    .addItem('一括処理', 'customUpdate')
    .addToUi();
}

/**
* カスタムメニューがクリックされた時に走る処理
*/
function customUpdate() {
  // xxx: ボタン誘導のコンテクスト
  // const selector = Browser.msgBox("じっこうするー", "実行することの意味を理解していますか？", Browser.Buttons.OK_CANCEL);
  // if (selector === 'cancel') {
  // return
  // }
const html = HtmlService.createTemplateFromFile('customUpdate.html').evaluate();
SpreadsheetApp.getUi().showModalDialog(html, '処理を止めたい場合は[x] 押す →');
}

function getDeploySheetDataList() {
  const dataSheet = activeSpreadsheet.getSheetByName('社員リスト');
  const lastRow = dataSheet.getLastRow();
  const deployData = dataSheet.getRange(`A2:C${lastRow}`).getValues();
  return deployData
}

/**
* 実行ログの吐き出し
*/
function setStatusLogs(times, logs) {
  const ws = activeSpreadsheet.insertSheet(`log:${times[0]}`);
  console.log('------------- set')
  SpreadsheetApp.flush();
  ws.getRange('A1:A2').setValues([[times[0]], [times[1]]]);
  const length = logs.length;
  ws.getRange(`B1:E${length}`).setValues(logs);
}
```

### 実行のコア

```html
<!DOCTYPE html>
<html>

<head>
  <base target="_top" />
  <script>
// --- 非同期処理準備
/* gasの関数で、Promise が返せるように */
// https://gist.github.com/torufurukawa/64339baf16efd3598e71dd763d1db0cf
function scriptRunPromise() {
  const gs = {};
  const keys = Object.keys(google.script.run);
  for (let i = 0; i < keys.length; i++) {
    gs[keys[i]] = (function (key) {
      return function (...args) {
        return new Promise(function (resolve, reject) {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            [key].apply(google.script.run, args);
        });
      };
    })(keys[i]);
  }
  return gs;
}

/**
 * 与えられたイテラブルから得られる関数を順に、
 * 指定された数まで並列に実行する。
 *
 * @param iterable {Iterable<() => Promise<void>}
 *  実行したい関数を要素に持つイテラブル。
 *  各関数は引数を持たず、Promise を返す。
 * @param concurrency {number} この数まで並列に実行する。
 * @return {Promise<void>}
 *  全ての関数を実行し終えると resolve される Promise。
 */
async function runConcurrentlyAsync(iterable, concurrency) {
  const iterator = iterable[Symbol.iterator]();
  let index = 0; // ログ用
  const promises = Array.from({ length: concurrency }, (_, id) => {
    return new Promise(async (resolve) => {
      for (
        let result = iterator.next();
        !result.done;
        result = iterator.next()
      ) {
        const i = index++;
        console.log(`${id}: ${i}...`);
        await result.value();
        console.log(`        ...${id}: ${i}`);
        prgrsbr.value = i; // プログレスバー用
      }
      resolve();
    });
  });
  await Promise.all(promises);
}
// --- 非同期処理準備終わり/

let prgrsbr, logDiv; // プログレスバー用
let startTimeLog, finishTimeLog;
let statusLogs = [];

window.addEventListener('load', () => {
  console.log('load: start');
  // sv-SEロケールはYYYY-MM-DD形式の日付文字列を戻す
  const _ymd = new Date().toLocaleDateString('sv-SE');
  const _time = new Date().toLocaleTimeString('ja-JP', { hour12: false });
  startTimeLog = `${_ymd}_${_time}`;

  setUpUI();
  // todo: 初回に一括でデータを取ってくるところ
  scriptRunPromise()
    .getDeploySheetDataList()
    .then((resolve) => asyncTouchSheets(resolve));
});
// エリアグループ名と、URL の配列が入っている
function asyncTouchSheets(arrayNameURLs) {
  const INIT = 0;
  const MAX = arrayNameURLs.length;
  const CONCURRENCY = 2; // 同時実行できる数を定義
  prgrsbr.max = MAX; // プログレスバー用

  const generator = (function* createGenerator() {
    for (let i = INIT; i < MAX; i++) {
      const [staffNum, staffName, mailAddress] = arrayNameURLs[i];
      const idx = i + 1;

      let stateSignal;

      // todo: 最終的に実行させる関数
      yield async () => {
        try {
          await scriptRunPromise().allCallFunc(
            staffNum,
            staffName,
            mailAddress
          );
          stateSignal = ['🟢', ''];
        } catch (error) {
          stateSignal = ['🔴', `${error}`];
        } finally {
          addLogText(
            `${stateSignal[0]}\t${idx}:\t${staffNum} \t${stateSignal[1]}`
          );
          statusLogs = [
            ...statusLogs,
            [stateSignal[0], idx, staffNum, stateSignal[1]],
          ];
        }
      };
    }
  })();

  runConcurrentlyAsync(generator, CONCURRENCY).then((resolve) => {
    const _ymd = new Date().toLocaleDateString('sv-SE');
    const _time = new Date().toLocaleTimeString('ja-JP', { hour12: false });
    finishTimeLog = `${_ymd}_${_time}`;

    google.script.run.setStatusLogs([startTimeLog, finishTimeLog], statusLogs);
    google.script.host.close();
  });
}

// 進捗プログレスバー作成用
function addLogText(logWord) {
  const logText = document.createElement('p');
  logText.style.margin = 0;
  logText.style.padding = 0;
  logText.textContent = `${logWord}`;
  // logDiv.appendChild(logText);
  logDiv.prepend(logText);
}

function setUpUI() {
  const wrap = document.createElement('main');
  prgrsbr = document.createElement('progress');
  prgrsbr.style.width = '100%';
  prgrsbr.min = 0;
  prgrsbr.value = 0;
  prgrsbr.style.position = 'sticky';
  prgrsbr.style.top = 0;
  const memo = document.createTextNode('😤 処理が終わったら自動で消えます');
  logDiv = document.createElement('div');
  logDiv.style.fontSize = '0.8rem';
  document.body.appendChild(wrap);
  wrap.appendChild(prgrsbr);
  wrap.appendChild(memo);
  wrap.appendChild(logDiv);
}

  </script>
</head>

<body></body>

</html>

```

### 逐次処理

```js
function allCallFunc(num, name, mail) {
  console.log(num);
  const s = SpreadsheetApp.openByUrl(mail);
  s.getSheetByName('a').getRange('A1').getValue()
}

```



## うーん

aside とかclap とか入れてやってみる？


# 📝 2025/08/12


## p5.sound の`reset`

> 
`p5.soundOut` is the p5.sound final output bus. It sends output to the destination of this window's web audio context. It contains Web Audio API nodes including a dyanmicsCompressor (<code>.limiter</code>), and Gain Nodes for <code>.input</code> and <code>.output</code>.
> `p5.soundOut` は p5.sound の最終出力バスです。このウィンドウの Web Audio コンテキストの宛先に出力を送信します。このバスには、Web Audio API ノード（dynamicsCompressor (<code>.limiter</code>) を含む）と、<code>.input</code> および <code>.output</code> 用の Gain ノードが含まれています。




# 📝 2025/08/11

[GitHub - tkihira/web-console-log](https://github.com/tkihira/web-console-log)



# 📝 2025/08/09

## `p5.Envelope`

[p5.Envelope](https://p5js.org/reference/p5.sound/p5.Envelope/)

play とかtrigger とか

ADSR の指定と、`constructor` のデフォルトとか





# 📝 2025/08/02


## p5 sound

- [getOctaveBands](https://p5js.org/reference/p5.FFT/getOctaveBands/)
- [logAverages](https://p5js.org/reference/p5.FFT/logAverages/)

ここら辺、良い感じにつかえるのかしら？

## module 化？

そもそも、`import` 読み込み設定せんとあかんか

spectrum analyzer とか、大きくなってしまったので、分けて使うか？



# 📝 2025/07/31

ai にコード聞くようになってから、ここで書かなくなってるや

スペクトラムアナライザーとしてlog スケールとかもごもごやってる





# 📝 2025/07/16

## [GitHub - pome-ta/p5js4codemirror6](https://github.com/pome-ta/p5js4codemirror6) todo


- module 化
    - 依存減らす
        - 具体的な変数で参照させない？
        - `querySelector` も極力使わないとか
    - 自由度高く
- プレビューの画面
    - 全画面
        - header を出したり、隠したり
        - canvas の指定サイズには忠実でありたい
- autocomplete
    - p5 用に
    - lsp でなくてもいい
- エディタ設定
    - テーマ関係が雑
- `.css`
    - module ごとの考え方とか
    - 全体のは、ほぼ使わないとか？
- スケッチファイル
    - 切り替えできると良き？
    - ストレージとか？
- console 出せるようにする？
- 音のノイズ
  - 終了時、更新時のノイズ
  - クリップノイズをなるべく排除したい